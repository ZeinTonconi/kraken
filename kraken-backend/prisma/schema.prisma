generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserStatus {
  ACTIVE
  DISABLED
}

enum GlobalRole {
  ADMIN
  TEACHER
  STUDENT
}

enum TeamRole {
  LEAD
  MEMBER
}

enum JobRole {
  DEVOPS
  FRONTEND
  BACKEND
  QA
}

enum WalletTxnType {
  COINS
  DIAMONDS
}

enum EnrollmentTrack {
  PRACTICA_INTERNA
  INDUCCION
}

enum EnrollmentStatus {
  APPLIED
  APPROVED
  REJECTED
  DROPPED
}

/**
 * NUEVOS enums para el programa de rotación
 */
enum ProgramOfferingType {
  PRACTICA_INTERNA
  INDUCCION
}

enum ProgramBlockType {
  LEADER_BLOCK       // 3 meses (solo aplica a líderes)
  JUNIOR_ROLE_BLOCK  // legacy: 2 meses (QA/FE/BE/DEVOPS para inducción)
  JUNIOR_BLOCK       // 2 meses (global, sin role)
  DOCS_BLOCK         // 1 mes (documentación)
}

enum ProgramStatus {
  DRAFT
  ACTIVE
  FINISHED
}

/**
 * Para restringir rol de líderes (solo 3)
 */
enum LeaderRole {
  QA
  FRONTEND
  BACKEND
  DEVOPS
}

model User {
  id           String     @id @default(uuid()) @db.Uuid
  email        String     @unique
  passwordHash String?    @map("password_hash")
  status       UserStatus @default(ACTIVE)
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  profile         Profile?
  wallet          Wallet?
  memberships     TeamMembership[]
  createdTeams    Team[]              @relation("TeamCreatedBy")
  walletTxns      WalletTransaction[] @relation("WalletTxnForUser")
  awardsGiven     WalletTransaction[] @relation("WalletTxnCreatedBy")
  offeringsTaught CourseOffering[]    @relation("OfferingTeacher")
  enrollments     Enrollment[]        @relation("EnrollmentStudent")
  programLeaders ProgramLeader[]

  @@map("users")
}

model Profile {
  userId    String     @id @map("user_id") @db.Uuid
  fullName  String     @map("full_name")
  handle    String?    @unique
  avatarUrl String?    @map("avatar_url")
  role      GlobalRole @default(STUDENT)
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

model Wallet {
  userId          String   @id @map("user_id") @db.Uuid
  coinsBalance    Int      @default(0) @map("coins_balance")
  diamondsBalance Int      @default(0) @map("diamonds_balance")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  transactions WalletTransaction[]

  @@map("wallets")
}

model WalletTransaction {
  id String @id @default(uuid()) @db.Uuid

  userId String @map("user_id") @db.Uuid

  walletUserId String @map("wallet_user_id") @db.Uuid

  type    WalletTxnType
  amount  Int
  reason  String
  refType String?       @map("ref_type")
  refId   String?       @map("ref_id")

  createdBy String   @map("created_by") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation("WalletTxnForUser", fields: [userId], references: [id], onDelete: Cascade)

  creator User @relation("WalletTxnCreatedBy", fields: [createdBy], references: [id], onDelete: Restrict)

  wallet Wallet @relation(fields: [walletUserId], references: [userId], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([walletUserId, createdAt])
  @@index([refType, refId])
  @@map("wallet_transactions")
}

model Term {
  id       String    @id @default(uuid()) @db.Uuid
  name     String
  year     Int
  period   String
  startsAt DateTime? @map("starts_at")
  endsAt   DateTime? @map("ends_at")

  offerings CourseOffering[]

  @@unique([name])
  @@index([year, period])
  @@map("terms")
}

model Course {
  id   String @id @default(uuid()) @db.Uuid
  code String @unique
  name String

  offerings CourseOffering[]

  @@map("courses")
}

model CourseOffering {
  id        String   @id @default(uuid()) @db.Uuid
  courseId  String   @map("course_id") @db.Uuid
  termId    String   @map("term_id") @db.Uuid
  teacherId String   @map("teacher_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  course  Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  term    Term   @relation(fields: [termId], references: [id], onDelete: Cascade)
  teacher User   @relation("OfferingTeacher", fields: [teacherId], references: [id], onDelete: Restrict)

  enrollments Enrollment[]
  teams       Team[]
  programLinks ProgramOffering[]

  @@index([courseId])
  @@index([termId])
  @@index([teacherId])
  @@map("course_offerings")
}

model Enrollment {
  id           String           @id @default(uuid()) @db.Uuid
  offeringId   String           @map("offering_id") @db.Uuid
  studentId    String           @map("student_id") @db.Uuid
  track        EnrollmentTrack
  academicYear Int              @map("academic_year")
  status       EnrollmentStatus @default(APPLIED)
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")
  primaryRole JobRole? @map("primary_role")  // el rol final asignado (cuenta para cupo)
  prefRole1   JobRole? @map("pref_role_1")  // elección 1 del usuario
  prefRole2   JobRole? @map("pref_role_2")  // elección 2 del usuario
  prefRole3   JobRole? @map("pref_role_3")  // tercero asignado por sistema


  offering    CourseOffering   @relation(fields: [offeringId], references: [id], onDelete: Cascade)
  student     User             @relation("EnrollmentStudent", fields: [studentId], references: [id], onDelete: Cascade)
  memberships TeamMembership[]

  @@unique([offeringId, studentId])
  @@index([studentId])
  @@index([offeringId, track])
  @@index([offeringId, track, status])
  @@index([offeringId, track, primaryRole])
  @@map("enrollments")
}

/**
 * Programa anual: une práctica interna e inducción para formar equipos mixtos.
 */
model RotationProgram {
  id           String   @id @default(uuid()) @db.Uuid
  academicYear Int      @map("academic_year")
  name         String
  startsAt     DateTime @map("starts_at")
  endsAt       DateTime @map("ends_at")
  status       ProgramStatus @default(DRAFT)
  startedAt    DateTime? @map("started_at")
  createdAt    DateTime @default(now()) @map("created_at")
  targetQaPct      Int @default(30) @map("target_qa_pct")
  targetFrontendPct Int @default(30) @map("target_frontend_pct")
  targetBackendPct Int @default(30) @map("target_backend_pct")
  targetDevopsPct  Int @default(10) @map("target_devops_pct")

  offerings ProgramOffering[]
  blocks    ProgramBlock[]
  leaders   ProgramLeader[]
  teams     Team[]

  @@unique([academicYear])
  @@index([startsAt, endsAt])
  @@map("rotation_programs")
}

/**
 * Link entre programa y offerings. Aquí defines cuál offering es práctica y cuál es inducción.
 */
model ProgramOffering {
  id        String              @id @default(uuid()) @db.Uuid
  programId String              @map("program_id") @db.Uuid
  offeringId String             @map("offering_id") @db.Uuid
  type      ProgramOfferingType

  program  RotationProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  offering CourseOffering  @relation(fields: [offeringId], references: [id], onDelete: Cascade)

  @@unique([programId, offeringId])
  @@index([programId, type])
  @@map("program_offerings")
}

/**
 * Bloques del programa:
 * - líderes: 3 bloques de 3 meses
 * - juniors: 4 bloques de 2 meses (con role=JobRole)
 * - doc_month: 1 bloque de 1 mes (sin role)
 */
model ProgramBlock {
  id        String           @id @default(uuid()) @db.Uuid
  programId String           @map("program_id") @db.Uuid
  type      ProgramBlockType
  order     Int              // 1..N por tipo
  label     String?
  startsAt  DateTime         @map("starts_at")
  endsAt    DateTime         @map("ends_at")
  createdAt DateTime         @default(now()) @map("created_at")

  role      JobRole?

  program RotationProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  teams Team[] @relation("TeamsByLeaderBlock")

  memberships TeamMembership[]

  @@unique([programId, type, order])
  @@index([programId, startsAt, endsAt])
  @@map("program_blocks")
}

model ProgramLeader {
  id        String     @id @default(uuid()) @db.Uuid
  programId String     @map("program_id") @db.Uuid
  userId    String     @map("user_id") @db.Uuid
  leaderRole LeaderRole @map("leader_role")
  active    Boolean    @default(true)
  createdAt DateTime   @default(now()) @map("created_at")

  program RotationProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  user    User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([programId, userId])
  @@index([programId, leaderRole, active])
  @@map("program_leaders")
}

model Team {
  id         String   @id @default(uuid()) @db.Uuid
  name       String

  offeringId String   @map("offering_id") @db.Uuid

  programId    String? @map("program_id") @db.Uuid
  leaderBlockId String? @map("leader_block_id") @db.Uuid

  createdBy  String   @map("created_by") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  offering CourseOffering   @relation(fields: [offeringId], references: [id], onDelete: Cascade)
  program  RotationProgram? @relation(fields: [programId], references: [id], onDelete: SetNull)

  leaderBlock ProgramBlock? @relation("TeamsByLeaderBlock", fields: [leaderBlockId], references: [id], onDelete: SetNull)

  creator  User             @relation("TeamCreatedBy", fields: [createdBy], references: [id], onDelete: Restrict)
  members  TeamMembership[]

  @@index([offeringId])
  @@index([createdBy])
  @@index([programId, leaderBlockId])
  @@map("teams")
}

model TeamMembership {
  id           String   @id @default(uuid()) @db.Uuid
  teamId       String   @map("team_id") @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  enrollmentId String   @map("enrollment_id") @db.Uuid

  blockId      String   @map("block_id") @db.Uuid

  teamRole     TeamRole @default(MEMBER) @map("team_role")
  jobRole      JobRole  @map("job_role")
  joinedAt     DateTime @default(now()) @map("joined_at")

  team       Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  block      ProgramBlock @relation(fields: [blockId], references: [id], onDelete: Cascade)

  @@unique([blockId, userId])
  @@unique([teamId, blockId, userId])

  @@index([userId])
  @@index([teamId])
  @@index([enrollmentId])
  @@index([blockId])
  @@map("team_memberships")
}
